#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ü–ü 1875 –¥–ª—è –û–ö–ü–î2'
–ü–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: —á—Ç–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—Å–µ—Ö –∏—Å—Ö–æ–¥–Ω—ã—Ö TSV-—Ñ–∞–π–ª–æ–≤.
"""

import sys
from pathlib import Path

def read_tsv_file(file_path, expected_columns, description):
    """
    –ß–∏—Ç–∞–µ—Ç TSV-—Ñ–∞–π–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π).
    –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º.
    """
    print(f"üìñ –ß—Ç–µ–Ω–∏–µ {description} ({file_path})...")
    
    if not file_path.exists():
        print(f"   ‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return None
    
    data = []
    line_num = 0
    problems = 0
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            for line in f:
                line_num += 1
                line = line.rstrip('\n')
                
                if not line.strip():
                    continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                
                # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ —Ç–∞–±—É–ª—è—Ü–∏–∏
                parts = line.split('\t')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
                if len(parts) != expected_columns:
                    print(f"   ‚ö†Ô∏è  –°—Ç—Ä–æ–∫–∞ {line_num}: –æ–∂–∏–¥–∞–µ—Ç—Å—è {expected_columns} –∫–æ–ª–æ–Ω–æ–∫, –Ω–∞–π–¥–µ–Ω–æ {len(parts)}")
                    print(f"      –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {line[:100]}...")
                    problems += 1
                    continue
                
                # –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
                cleaned_parts = [part.strip() for part in parts]
                data.append(cleaned_parts)
                
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
        return None
    
    print(f"   ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {len(data)}")
    if problems > 0:
        print(f"   ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: {problems}")
    
    return data

def parse_okpd2_data(okpd2_rows):
    """–ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –û–ö–ü–î2 –∏ –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–∏–º–µ—Ä—ã."""
    print("\nüîç –ê–Ω–∞–ª–∏–∑ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –û–ö–ü–î2:")
    
    if not okpd2_rows:
        print("   ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
        return
    
    print(f"   –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(okpd2_rows)}")
    print("\n   –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π (–ø–µ—Ä–≤—ã–µ 5):")
    for i, row in enumerate(okpd2_rows[:5]):
        print(f"      {i+1}. –ö–æ–¥: '{row[0]}', –ù–∞–∑–≤–∞–Ω–∏–µ: '{row[1][:60]}...'")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–æ–≤
    codes = [row[0] for row in okpd2_rows]
    unique_codes = set(codes)
    if len(codes) != len(unique_codes):
        print(f"   ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–∞–π–¥–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∫–æ–¥—ã!")
    else:
        print(f"   ‚úÖ –í—Å–µ –∫–æ–¥—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã")

def parse_app_data(app_rows, app_name, has_quota=False):
    """–ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–∏–º–µ—Ä—ã."""
    print(f"\nüîç –ê–Ω–∞–ª–∏–∑ {app_name}:")
    
    if not app_rows:
        print("   ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
        return
    
    print(f"   –í—Å–µ–≥–æ –ø—É–Ω–∫—Ç–æ–≤: {len(app_rows)}")
    print(f"   –ö–æ–ª–æ–Ω–∫–∏: '–ü—É–Ω–∫—Ç', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ö–æ–¥ –û–ö–ü–î2'" + (", '–ö–≤–æ—Ç–∞'" if has_quota else ""))
    
    print("\n   –ü—Ä–∏–º–µ—Ä—ã –ø—É–Ω–∫—Ç–æ–≤ (–ø–µ—Ä–≤—ã–µ 3):")
    for i, row in enumerate(app_rows[:3]):
        point_info = f"      {i+1}. –ü—É–Ω–∫—Ç: '{row[0]}', –ù–∞–∑–≤–∞–Ω–∏–µ: '{row[1][:40]}...'"
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–µ —Å –∫–æ–¥–∞–º–∏
        codes_str = row[2]
        # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º, –∑–∞—Ç–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        test_codes = [code.strip() for code in codes_str.replace(',', ' ').split() if code.strip()]
        
        point_info += f", –ö–æ–¥—ã: '{codes_str}'"
        if len(test_codes) > 1:
            point_info += f" (—Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ {len(test_codes)} –∫–æ–¥–∞: {test_codes})"
        
        if has_quota and len(row) > 3:
            point_info += f", –ö–≤–æ—Ç–∞: '{row[3]}'"
        
        print(point_info)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤ –ø—É–Ω–∫—Ç–æ–≤
    points = [row[0] for row in app_rows]
    unique_points = set(points)
    if len(points) != len(unique_points):
        print(f"   ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–∞–π–¥–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤!")
    else:
        print(f"   ‚úÖ –í—Å–µ –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã")

def main():
    print("=" * 70)
    print("üîß –°–ö–†–ò–ü–¢ –°–ë–û–†–ö–ò –î–ê–ù–ù–´–• –î–õ–Ø –°–ü–†–ê–í–û–ß–ù–ò–ö–ê –ü–ü 1875")
    print("   –ü–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    print("=" * 70)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
    base_dir = Path(".")
    
    source_files = {
        "okpd2": (base_dir / "source_okpd2.tsv", 2, "–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –û–ö–ü–î2"),
        "app1": (base_dir / "source_pp1875_app1.tsv", 3, "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 1"),
        "app2": (base_dir / "source_pp1875_app2.tsv", 3, "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 2"),
        "app3": (base_dir / "source_pp1875_app3.tsv", 4, "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 3 (—Å –∫–≤–æ—Ç–æ–π)"),
    }
    
    # –ß–∏—Ç–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
    data = {}
    for key, (file_path, expected_cols, description) in source_files.items():
        rows = read_tsv_file(file_path, expected_cols, description)
        if rows is not None:
            data[key] = rows
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    missing_files = [key for key in source_files if key not in data]
    if missing_files:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã: {', '.join(missing_files)}")
        print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É.")
        sys.exit(1)
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
    parse_okpd2_data(data["okpd2"])
    parse_app_data(data["app1"], "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 1", has_quota=False)
    parse_app_data(data["app2"], "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 2", has_quota=False)
    parse_app_data(data["app3"], "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è 3", has_quota=True)
    
    # –°–≤–æ–¥–∫–∞
    print("\n" + "=" * 70)
    print("üìä –°–í–û–î–ö–ê –ü–û –î–ê–ù–ù–´–ú:")
    print(f"   ‚Ä¢ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –û–ö–ü–î2: {len(data['okpd2'])} –∑–∞–ø–∏—Å–µ–π")
    print(f"   ‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 1: {len(data['app1'])} –ø—É–Ω–∫—Ç–æ–≤")
    print(f"   ‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 2: {len(data['app2'])} –ø—É–Ω–∫—Ç–æ–≤")
    print(f"   ‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 3: {len(data['app3'])} –ø—É–Ω–∫—Ç–æ–≤")
    print("\n‚úÖ –ü–ï–†–í–ê–Ø –ò–¢–ï–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print("   –í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ—á–∏—Ç–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.")
    print("=" * 70)

if __name__ == "__main__":
    main()